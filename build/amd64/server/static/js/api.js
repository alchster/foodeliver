var apiPath="/api";function orders(){$(".provider__item-status select").selectmenu({change:function(){var t=$(this);apiCall("PUT","/order/"+t.closest(".provider__item").find(".provider__item-order-id").html(),{status_code:parseInt(t.val())})}})}function categories(){$(".btn.catalog__create-new").click(function(){var t=$(this).closest(".catalog__category").find("input").val().trim();""!==t&&apiCall("POST","/category",{name:t}).done(function(){window.location=window.location})}),$(".catalog__btn-edit").click(function(){var t=$(this).closest(".catalog__item"),e=t.find("input");t.hasClass("active-delete")||(t.toggleClass("active-edit"),t.hasClass("active-edit")?e.removeAttr("disabled"):e.attr("disabled",!0))}),$(".catalog__btn-delete, .catalog__btn-delete-cancel").click(function(){var t=$(this).closest(".catalog__item");t.hasClass("active-edit")||t.toggleClass("active-delete")}),$(".btn.catalog__btn-save").click(function(){var t=$(this).closest(".catalog__item"),e=t.attr("data-cat-id"),i=t.find("input").val().trim();""!==i&&apiCall("PUT","/text/"+e,{ru:i,en:i}).done(function(){window.location=window.location})}),$(".btn.catalog__btn-delete-accept").click(function(){apiCall("DELETE","/category/"+$(this).closest(".catalog__item").attr("data-cat-id")).done(function(){window.location=window.location})})}function statusChangeUpdate(t){var e=t.find("select").val(),i=t.find("option[value="+e+"]");t.find("[data-status-total-place]").html(i.attr("data-status-total")),t.find("[data-status-at-period-place]").html(i.attr("data-status-at-period"))}function statistics(){$(".datepicker").each(function(){var t=$(this).val();$(this).datepicker("option","dateFormat","yy/mm/dd").datepicker("setDate",t)});var t=$("#category-counter"),e=t.find("select");t.attr("data-num",e.val()),e.selectmenu({change:function(){self=$(this),t.attr("data-num",self.val())}}),$("[data-sup-id]").each(function(){statusChangeUpdate($(this))}),$("[data-sup-id] select").selectmenu({change:function(){statusChangeUpdate($(this).closest("[data-sup-id]"))}});var n=$("#orders-start"),o=$("#orders-end");$(".datepicker").change(function(){var i=$(this),a=i.closest("[data-type]"),t=a.find(".datepicker");apiCall("GET","/getstat",{type:a.attr("data-type"),start:$(t[0]).val(),end:$(t[1]).val()}).done(function(t){if(i.is(n)||i.is(o))$.each(t.suppliers,function(t,e){var a=$("[data-sup-id="+e.id+"]");a.find("[data-total-place]").html(e.summary.total),a.find("[data-at-period-place]").html(e.summary.at_period),a.find("[data-sum-total-place]").html(e.sum_total),a.find("[data-sum-at-period-place]").html(e.sum_at_period),a.find("[data-charge-total-place]").html(e.charge_total),a.find("[data-charge-at-period-place]").html(e.charge_at_period);$.each(e.by_status,function(t,e){0;var i=a.find("option[value="+t+"]");i.attr("data-status-total",e.stats.total),i.attr("data-status-at-period",e.stats.at_period)}),statusChangeUpdate(a)});else{var e=a.find(".statistic__service-txt");$(e[0]).html(t.total),$(e[1]).html(t.at_period)}})})}function supList(){$(".suppliers-info__row--status select").selectmenu({change:function(t,e){var i=$(e.item.element).closest(".suppliers-info__item");apiCall("PUT","/supplier/"+i.find(".suppliers-info__supplier-id").html(),{status_code:parseInt(e.item.value)}).done(function(){-1==e.item.value?i.find(".suppliers-info__tools").show():i.find(".suppliers-info__tools").hide()})}}),$(".suppliers-info__item .suppliers-info__editing").click(function(){var e=$(this),i=e.closest(".suppliers-info__item"),a=i.find(".suppliers-info__supplier-id").html();i.toggleClass("editing"),i.hasClass("editing")?(i.find("input").removeAttr("disabled"),i.find(".suppliers-info__bottom").show()):(i.find("input").attr("disabled",!0),i.find(".suppliers-info__bottom").hide()),i.find(".suppliers-info__btn").click(function(){var t={description:i.find(".suppliers-info__api-name").val()||void 0,itn:i.find(".suppliers-info__api-itn").val()||void 0,phone:i.find(".suppliers-info__api-phone").val()||void 0,email:i.find(".suppliers-info__api-email").val()||void 0,address:i.find(".suppliers-info__api-addr").val()||void 0,login:i.find(".suppliers-info__api-login").val()||void 0,password:i.find(".suppliers-info__api-pass").val()||void 0};apiCall("PUT","/supplier/"+a,t).then(function(){e.click()})})})}function moder(){$(".moderator-catalog__status-select .custom-select-center").each(function(){var t=$(this),e=t.closest(".select-center"),a=e.siblings(".js-color"),n=e.siblings(".js-cause-message"),o=e.siblings(".js-date-not-available");t.selectmenu({appendTo:e,change:function(t,e){e.item.element.data("color");var i=e.item.element.data("status");"new"==i?(a.css("background-color","#f5a623"),n.hide(),o.hide()):"not-available"==i?(a.css("background-color","#9b9b9b"),n.hide(),o.show(),o.addClass("active")):"approved"==i?(a.css("background-color","#7ed321"),n.hide(),o.hide()):"not-approved"==i&&(a.css("background-color","#ff0033"),n.show(),o.hide(),n.addClass("active")),apiCall("PUT","/product/"+$(this).closest(".moderator-catalog__item").find(".moderator-catalog__api-product-id").html(),{status_code:parseInt($(this).val())})},create:function(t,e){var i=$(this).children(":selected").data("status");"new"==i?a.css("background-color","#f5a623"):"not-available"==i?a.css("background-color","#9b9b9b"):"approved"==i?a.css("background-color","#7ed321"):"not-approved"==i&&a.css("background-color","#ff0033")}})}),$(".js-save .moderator-catalog__btn").click(function(){var t=$(this).closest(".moderator-catalog__item");apiCall("PUT","/product/"+t.find(".moderator-catalog__api-product-id").html(),{status_text:t.find(".moderator-catalog__cause textarea").val()}).done(function(){t.find(".js-cause-message").hide()})});var o={"filter-supplier":"none","filter-category":"none","filter-status":"none"};$(".moderator-catalog__select select").selectmenu({change:function(){self=$(this),o[self[0].id]=self.val(),$(".moderator-catalog__item").each(function(t,e){var i=$(e),a=!0,n={"filter-supplier":i.find(".moderator-catalog__api-supplier-id").html(),"filter-category":i.find(".moderator-catalog__api-category-id").html(),"filter-status":i.find(".custom-select-center").val()};$.each(o,function(t,e){if(!(a="none"===o[t]||n[t]===o[t]))return!1});a?i.show:i.hide;a?i.show():i.hide()})}})}function catalog(){$(".provider-catalog__save-btn button").click(function(t){t.preventDefault();var e=$(this).closest(".provider-catalog__add"),i=e.find(".provider-catalog__col-add--info-center .provider-catalog__col-input input:text").val(),a=e.find(".provider-catalog__col-textarea textarea").val();apiCall("POST","/product",{supplier_id:$(".header__user-id").html(),name:{en:i,ru:i},description:{en:a,ru:a},category_id:e.find(".provider-catalog__col-select select").val(),cost:parseFloat(e.find(".provider-catalog__col-add--info-right .provider-catalog__col-input input:text").val()),image:e.find(".provider-catalog__api-img").prop("src").replace(location.origin,"")}).done(function(){window.location=window.location})}),$(".provider-catalog__save-catalog button").click(function(t){t.preventDefault();var e=$(this).closest(".provider-catalog__item-card"),i=e.find(".provider-catalog__product-id").html(),a=e.find(".provider-catalog__col--info-center .provider-catalog__name-goods input:text").val(),n=e.find(".provider-catalog__name-id").html(),o=e.find(".provider-catalog__descr .editor").html(),s=e.find(".provider-catalog__descr-id").html();apiCall("PUT","/product/"+i,{supplier_id:$(".header__user-id").html(),category_id:e.find(".provider-catalog__category-select select").val(),cost:parseFloat(e.find(".provider-catalog__col--info-right .provider-catalog__price-input input:text").val()),image:e.find(".provider-catalog__api-img").prop("src").replace(location.origin,"")}).then(function(){apiCall("PUT","/text/"+n,{ru:a})}).then(function(){apiCall("PUT","/text/"+s,{ru:o})}).done(function(){window.location=window.location})}),$(".js-delete-catalog, .provider-catalog__button-cancel").click(function(){var t=$(this).closest(".provider-catalog__item-card");t.children(".provider-catalog__delete-item").toggle(),t.find(".js-edit-catalog").toggle()}),$(".provider-catalog__button-delete").click(function(){apiCall("DELETE","/product/"+$(this).closest(".provider-catalog__item-card").find(".provider-catalog__product-id").html()).done(function(){window.location=window.location})}),$(".provider-catalog__btn-file input:file").on("change",function(t){var e,i,a,n=$(t.target),o=n.parents(".provider-catalog__api-item").find(".provider-catalog__api-img"),s=n.prop("files")[0];e=s,i=o,(a=new FormData).append("file",e),$.ajax({method:"POST",enctype:"multipart/form-data",url:"/files",data:a,processData:!1,contentType:!1,cache:!1,timeout:5e3}).done(function(t){i.prop("src",t.url)},function(t){console.log(t)})}),$("[data-category-filter]").click(function(){var a=$(this).attr("data-category-filter");$("[data-category]").each(function(t,e){var i=$(e);"*"===a||i.attr("data-category")===a?i.show():i.hide()})})}function delivery(){$(".delivery-settings__item .delivery-settings__switch input:checkbox").change(function(){var e=this,t=$(e).closest(".delivery-settings__item"),i={station_id:t.find(".delivery-settings__station-id").html(),min_amount:parseFloat(t.find(".delivery-settings__min-amount input").val()),delivery_time:parseInt(t.find(".delivery-settings__time input").val()),working_from:t.find(".delivery-settings__api-time-from").val(),working_to:t.find(".delivery-settings__api-time-to").val()};e.checked?apiCall("POST","/supstation",i).fail(function(t){e.checked=!e.checked}):apiCall("DELETE","/supstation",i).fail(function(t){e.checked=!e.checked})}),$(".delivery-settings__item select").change(function(){var t=$(this).closest(".delivery-settings__item");apiCall("POST","/supstation",{station_id:t.find(".delivery-settings__station-id").html(),min_amount:parseFloat(t.find(".delivery-settings__min-amount input").val()),delivery_time:parseInt(t.find(".delivery-settings__time input").val()),working_from:t.find(".delivery-settings__api-time-from").val(),working_to:t.find(".delivery-settings__api-time-to").val()})})}function admin(){$(".moderators__row .moderators__col--large .js-multiselect").on("select2:select",function(t){apiCall("POST","/modsupplier",{moderator:$(this).closest(".moderators__item").find(".moderators__user-id").html(),supplier:t.params.data.id})}).on("select2:unselect",function(t){apiCall("DELETE","/modsupplier",{moderator:$(this).closest(".moderators__item").find(".moderators__user-id").html(),supplier:t.params.data.id})}),$(".admin____stations .item-station__switch input:checkbox").change(function(t){var e=$(this.closest(".item-station")).find(".item-station__id").html(),i=this;apiCall("PUT","/station/"+e,{active:this.checked}).fail(function(){i.checked=!i.checked})}),$(".admin____trains .item-station__switch input:checkbox").change(function(t){var e=$(this.closest(".item-station")).find(".item-station__id").html(),i=this;apiCall("PUT","/train/"+e,{active:this.checked}).fail(function(){i.checked=!i.checked})});var a=$(".admin____service .admin____service-id").html(),e=$(".admin____service select.admin____service-type").val(),i=$(".admin____service .admin____service-active input:checkbox")[0];i&&(i.checked="true"==$(".admin____service .admin____service-"+e).html()),$(".admin____service select.admin____service-type").selectmenu({change:function(){e=$(".admin____service select.admin____service-type").val();var t=$(".admin____service .admin____service-"+e).html();i.checked="true"==t}}),$(i).change(function(){var t={};t[e.replace("-","_")]=i.checked,apiCall("PUT","/service/"+a,t).then(function(){$(".admin____service .admin____service-"+e).html(i.checked)},function(){i.checked=!i.checked})});var n=$(".admin____service .admin____service-percent input").val(),o=$(".admin____service .admin____service-fixed input").val(),s=$(".admin____service .admin____service-timeout input").val();$(".admin____service .admin____service-percent input").change(function(t){t.preventDefault();var e=$(this),i=parseInt(e.val());apiCall("PUT","/service/"+a,{charge_percent:i}).then(function(){n=i},function(){e.val(n)})}),$(".admin____service .admin____service-fixed input").change(function(t){t.preventDefault();var e=$(this),i=parseInt(e.val());apiCall("PUT","/service/"+a,{charge_fixed:i}).then(function(){o=i},function(){e.val(o)})}),$(".admin____service .admin____service-timeout input").change(function(t){t.preventDefault();var e=$(this),i=parseInt(e.val());apiCall("PUT","/service/"+a,{minutes_for_payment:i}).then(function(){s=i},function(){e.val(s)})})}function settings(){var n=$(".settings__err-old-pass"),o=$(".settings__err-new-pass"),s=$(".header__user-id").html(),e=($(".header__user-login").html(),$(".header__user-type").html()),c=$("input[name=old-pass]"),l=$("input[name=new-pass"),r=$("input[name=new-pass-rep]"),t=$(".settings__change-pass");n.hide(),o.hide(),$(c).change(function(){var t=c.val();apiCall("POST","/check_password",{id:s,type:e,password:t}).then(function(){n.hide()},function(t){n.show()})});var i=function(t){var e=l.val(),i=r.val();""==e||""==i?newValid=!1:e!=i?o.show():o.hide()};$([l,r]).each(function(){$(this).change(i)}),$(t).click(function(t){t.preventDefault();var e=c.val(),i=l.val(),a=r.val();""!==e&&""!==i&&""!==a&&i===a&&n.is(":hidden")&&o.is(":hidden")&&apiCall("PUT","/user/"+s,{password:i}).then(function(t){window.location=window.location})})}function accounts(){$(".moderators__list .switch input:checkbox").change(function(t){var e=this,i=$(this).closest(".js-moderators-item"),a=$(i).find(".moderators__user-id").html(),n="/"+$(i).find(".moderators__user-type").html(),o="/supplier"===n?{status_code:this.checked?1:0}:{enabled:this.checked};apiCall("PUT",n+"/"+a,o).then(function(){if("/supplier"===n){var t=$(i).find(".moderators__status");t.removeClass(["active","blocked"]).addClass(["blocked","","active"][o.status_code+1]),t.parent().next().html(["заблокирован","неактивен","активен"][o.status_code+1])}},function(){e.checked=!e.checked})}),$(".moderators__list .moderators__form").submit(function(t){t.preventDefault();var e=$(this).closest(".js-moderators-item"),i=$(e).find(".moderators__user-id").html();apiCall("PUT","/"+$(e).find(".moderators__user-type").html()+"/"+i,{login:$(this).find("input[name=login]").val(),password:$(this).find("input[name=password]").val()})}),$(".moderators__item--add .moderators__btn-create").click(function(t){t.preventDefault();var e=$(this).closest(".moderators__item--add"),i=$(e).find("input[name=description]").val(),a=$(e).find("select[name=Select]").val(),n=$(e).find("input[name=login]").val(),o=$(e).find("input[name=password]").val(),s=$(e).find("input[name=email]").val();""!==i&&apiCall("POST","supplier"===a?"/supplier":"/user",{description:i,login:n,password:o,email:s,admin:"administrator"===a}).then(function(t){window.location=window.location})}),$(".moderators__list .js-moderators-del").click(function(){var t=$(this).closest(".js-moderators-item"),e=$(t).find(".moderators__user-id").html();apiCall("DELETE","/"+$(t).find(".moderators__user-type").html()+"/"+e)})}function apiCall(t,e,i){var a;return t=t.toUpperCase(),e=apiPath+e,"GET"!==t&&(i=JSON.stringify(i||{}),a="application/json; charser=utf-8"),console.log("API call: ["+t+"] "+e+' data: "'+i+'"'),$.ajax({type:t,url:e,data:i,contentType:a,statusCode:{401:function(){window.location="/logout"}}})}$(function(){$(".head-search__box").hide(),$(".header__logout .header__menu-link").click(function(){window.location="/logout"}),accounts(),settings(),admin(),delivery(),catalog(),moder(),supList(),statistics(),categories(),orders()});